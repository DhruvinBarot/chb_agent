{% extends "base.html" %}
{% block title %}Chat ¬∑ CHB Assistant{% endblock %}

{% block content %}
<section class="row">
  <div class="col col-8">
    <div id="chatbox" class="card chatbox"></div>

    <div class="row gap">
      <input type="text" id="message" placeholder="Ask about pain, substance use, or a specific paper‚Ä¶"/>
      <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>

    <div class="row gap">
      <label><input type="checkbox" id="autoExpand"/> Auto-expand sources</label>
      <span class="muted">Answers show first. Sources stay collapsed unless expanded.</span>
    </div>
  </div>

  <div class="col col-4">
    <div class="card">
      <h3>üì• Upload PDF</h3>
      <input type="file" id="pdfFile" accept="application/pdf"/>
      <button onclick="uploadPdf()">Upload</button>
      <div id="uploadResult" class="muted"></div>
    </div>

    <div class="card">
      <h3>üóÇ Ingestion</h3>
      <button onclick="reindex()">Reindex PDFs</button>
      <pre id="reindexOut" class="muted small"></pre>
    </div>

    <div class="card">
      <h3>üìä Status</h3>
      <pre id="statusOut" class="muted small"></pre>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// basic helpers
function escapeHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function dedupeSources(arr){const seen=new Set(),out=[];for(const r of (arr||[])){const k=`${r.source||'unknown'}::${r.chunk??-999}`;if(!seen.has(k)){seen.add(k);out.push(r)}}return out;}
function truncate(s,n=180){if(!s) return ""; s=s.trim(); return s.length>n? s.slice(0,n)+"‚Ä¶": s;}
function latestAssistant(context){const ctx=Array.isArray(context)?context:[];const last=[...ctx].reverse().find(m=>m.role==="assistant");return last?.message;}

function renderSources(retrieval){
  const items = dedupeSources(retrieval);
  if(!items.length) return "";
  const count = items.length;
  const autoExpand = document.getElementById('autoExpand')?.checked;
  let list = "";
  for(const r of items){
    const title = escapeHtml(r.source||"unknown.pdf");
    const chunk = (r.chunk!==undefined && r.chunk!==null) ? ` (chunk ${r.chunk})`:"";
    const full  = escapeHtml(r.excerpt||"");
    const short = truncate(full, 180);
    const uid   = "exp-"+Math.random().toString(36).slice(2);
    list += `
      <div class="cite">
        <div class="cite-title">‚Ä¢ ${title}${chunk}</div>
        <div class="cite-excerpt" id="${uid}" data-full="${full}" data-short="${short}">${short}</div>
        ${full.length>short.length? `<span class="link" onclick="toggleExcerpt('${uid}')">show more</span>`:""}
      </div>`;
  }
  return `<div class="sources">
    <details ${autoExpand?"open":""}>
      <summary>üìö Sources <span class="pill">${count}</span></summary>
      ${list}
    </details>
  </div>`;
}

function toggleExcerpt(id){
  const el = document.getElementById(id);
  const isShort = el.textContent.endsWith("‚Ä¶") || el.textContent===el.dataset.short;
  el.textContent = isShort ? el.dataset.full : el.dataset.short;
  const link = el.nextElementSibling;
  if(link && link.classList.contains("link")) link.textContent = isShort? "show less":"show more";
}

// chat send
async function sendMessage(){
  const input = document.getElementById('message');
  const msg = input.value.trim();
  if(!msg) return;

  const box = document.getElementById('chatbox');
  box.innerHTML += `<div class="msg"><span class="user">You:</span> ${escapeHtml(msg)}</div>`;
  input.value = '';

  const loaderId = "loader-"+Date.now();
  box.innerHTML += `<div id="${loaderId}" class="muted">AI is thinking‚Ä¶</div>`;
  box.scrollTop = box.scrollHeight;

  try{
    const res = await fetch('/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({thread_id:'web_ui', message: msg})
    });
    const data = await res.json();
    document.getElementById(loaderId)?.remove();

    const answer = data.generated_answer || latestAssistant(data.context) || data.normalized_message || "‚ö†Ô∏è No answer generated.";
    const sources = renderSources(Array.isArray(data.retrieval)? data.retrieval:[]);
    box.innerHTML += `<div class="msg">
      <span class="bot">AI:</span>
      <div class="answer">${escapeHtml(answer)}</div>
      ${sources}
    </div>`;
  }catch(err){
    document.getElementById(loaderId)?.remove();
    box.innerHTML += `<div class="msg"><span class="bot">AI:</span> <span class="error"><b>Error:</b> ${escapeHtml(err.message||String(err))}</span></div>`;
  }
  box.scrollTop = box.scrollHeight;
}

// upload PDF
async function uploadPdf(){
  const inp = document.getElementById('pdfFile');
  const out = document.getElementById('uploadResult');
  if(!inp.files.length){ out.textContent="Choose a PDF first."; return; }
  const fd = new FormData();
  fd.append("file", inp.files[0]);
  out.textContent = "Uploading‚Ä¶";
  try{
    const res = await fetch('/upload', {method:'POST', body: fd});
    const data = await res.json();
    out.textContent = data.ok ? `Uploaded: ${data.saved_as}` : (data.detail||"Upload failed");
  }catch(e){ out.textContent = "Upload error: " + e.message; }
}

// reindex
async function reindex(){
  const out = document.getElementById('reindexOut');
  out.textContent = "Reindexing‚Ä¶";
  try{
    const res = await fetch('/admin/reindex', {method:'POST'});
    const data = await res.json();
    out.textContent = JSON.stringify(data, null, 2);
    await refreshStatus();
  }catch(e){ out.textContent = "Reindex error: " + e.message; }
}

// status
async function refreshStatus(){
  const out = document.getElementById('statusOut');
  try{
    const res = await fetch('/status');
    const data = await res.json();
    out.textContent = JSON.stringify(data, null, 2);
  }catch(e){ out.textContent = "Status error: " + e.message; }
}
refreshStatus();

// Enter to send
document.getElementById('message').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

</script>
{% endblock %}
